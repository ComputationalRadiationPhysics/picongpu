CUDA GPUs
=========

Mapping the abstraction to GPUs supporting *CUDA* is straightforward because the hierarchy levels are identical up to the element level.
So blocks of warps of threads will be mapped directly to their *CUDA* equivalent.

The element level is supported through an additional run-time variable containing the extent of elements per thread.
This variable can be accessed by all threads and should optimally be placed in constant device memory for fast access.

Porting CUDA to *alpaka*
------------------------

Nearly all CUDA functionality can be directly mapped to alpaka function calls.
A major difference is that CUDA requires the block and grid sizes to be given in (x, y, z) order. alpaka uses the mathematical C/C++ array indexing scheme [z][y][x]. In both cases x is the innermost / fast running index.

Furthermore alpaka does not require the indices and extents to be 3-dimensional.
The accelerators are templatized on and support arbitrary dimensionality.
NOTE: Currently the CUDA implementation is restricted to a maximum of 3 dimensions!

NOTE: You have to be careful when mixing alpaka and non alpaka CUDA code. The CUDA-accelerator back-end can change the current CUDA device and will NOT set the device back to the one prior to the invocation of the alpaka function.


Programming Interface
+++++++++++++++++++++

*Function Attributes*

.. table::

   +-----------------------------------------------------+---------------------------------------------------------+
   | CUDA                                                | alpaka                                                  |
   +=====================================================+=========================================================+
   | ``__host__``                                        | ``ALPAKA_FN_HOST``                                      |
   +-----------------------------------------------------+---------------------------------------------------------+
   | ``__device__``                                      | ``ALPAKA_FN_ACC``                                       |
   +-----------------------------------------------------+---------------------------------------------------------+
   | ``__global__``                                      | ``ALPAKA_FN_ACC``                                       |
   +-----------------------------------------------------+---------------------------------------------------------+
   | ``__host__ __device__``                             | ``ALPAKA_FN_HOST_ACC``                                  |
   +-----------------------------------------------------+---------------------------------------------------------+

.. note::

   You can not call CUDA-only methods, except when ``ALPAKA_ACC_GPU_CUDA_ONLY_MODE`` is enabled.

*Memory*

.. table::

   +-----------------------------------------------------+----------------------------------------------------------------------------+
   | CUDA                                                | alpaka                                                                     |
   +=====================================================+============================================================================+
   | ``__shared__``                                      | ``alpaka::block::shared::st::allocVar<std::uint32_t, __COUNTER__>(acc)``   |
   +-----------------------------------------------------+----------------------------------------------------------------------------+
   | ``__constant__``                                    | ``ALPAKA_STATIC_ACC_MEM_CONSTANT``                                         |
   +-----------------------------------------------------+----------------------------------------------------------------------------+
   | ``__device__``                                      | ``ALPAKA_STATIC_ACC_MEM_GLOBAL``                                           |
   +-----------------------------------------------------+----------------------------------------------------------------------------+

.. doxygenfunction:: alpaka::block::shared::st::allocVar
   :project: alpaka

.. doxygendefine:: ALPAKA_STATIC_ACC_MEM_CONSTANT
   :project: alpaka

.. doxygendefine:: ALPAKA_STATIC_ACC_MEM_GLOBAL
   :project: alpaka

*Index / Work Division*

.. table::

    +---------------------------------+----------------------------------------------------------------------------------+
    | CUDA                            | alpaka                                                                           |
    +=================================+==================================================================================+
    | ``threadIdx``                   | ``alpaka::idx::getIdx<alpaka::Block, alpaka::Threads>(acc)``                     |
    +---------------------------------+----------------------------------------------------------------------------------+
    | ``blockIdx``                    | ``alpaka::idx::getIdx<alpaka::Grid, alpaka::Blocks>(acc)``                       |
    +---------------------------------+----------------------------------------------------------------------------------+
    | ``blockDim``                    | ``alpaka::workdiv::getWorkDiv<alpaka::Block, alpaka::Threads>(acc)``             |
    +---------------------------------+----------------------------------------------------------------------------------+
    | ``gridDim``                     | ``alpaka::workdiv::getWorkDiv<alpaka::Grid, alpaka::Blocks>(acc)``               |
    +---------------------------------+----------------------------------------------------------------------------------+
    | ``warpSize``                    | ``alpaka::warp::getSize(acc)``                                                   |
    +---------------------------------+----------------------------------------------------------------------------------+

*Types*

.. table::

    +----------+-------------------------------------+
    | CUDA     | alpaka                              |
    +==========+=====================================+
    | ``dim3`` | ``alpaka::vec::Vec< TDim, TVal >``  |
    +----------+-------------------------------------+



CUDA Runtime API
----------------

The following tables list the functions available in the `CUDA Runtime API <https://docs.nvidia.com/cuda/cuda-runtime-api/modules.html#modules>`_ and their equivalent alpaka functions:

*Device Management*

.. table::

    +---------------------------------+-----------------------------------------------------------------------+
    | CUDA                            | alpaka                                                                |
    +=================================+=======================================================================+
    | cudaChooseDevice                | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetAttribute          | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetByPCIBusId         | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetCacheConfig        | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetLimit              | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetP2PAttribute       | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetPCIBusId           | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetSharedMemConfig    | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceGetQueuePriorityRange | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceReset                 | alpaka::dev::reset(device)                                            |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceSetCacheConfig        | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceSetLimit              | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceSetSharedMemConfig    | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaDeviceSynchronize           | void alpaka::wait::wait(device)                                       |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaGetDevice                   | n/a (no current device)                                               |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaGetDeviceCount              | std::sizet alpaka::pltf::getDevCount< TPltf >()                       |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaGetDeviceFlags              | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaGetDeviceProperties         | alpaka::acc::getAccDevProps(dev) (Only some properties available)     |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaIpcCloseMemHandle           | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaIpcGetEventHandle           | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaIpcGetMemHandle             | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaIpcOpenEventHandle          | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaIpcOpenMemHandle            | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaSetDevice                   | n/a (no current device)                                               |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaSetDeviceFlags              | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+
    | cudaSetValidDevices             | --                                                                    |
    +---------------------------------+-----------------------------------------------------------------------+


*Error Handling*

.. table::

    +---------------------+----------------------------------------------------------+
    | CUDA                | alpaka                                                   |
    +=====================+==========================================================+
    | cudaGetErrorName    | n/a (handled internally, available in exception message) |
    +---------------------+----------------------------------------------------------+
    | cudaGetErrorString  | n/a (handled internally, available in exception message) |
    +---------------------+----------------------------------------------------------+
    | cudaGetLastError    | n/a (handled internally)                                 |
    +---------------------+----------------------------------------------------------+
    | cudaPeekAtLastError | n/a (handled internally)                                 |
    +---------------------+----------------------------------------------------------+


*Queue Management*

.. table::

    +------------------------------+---------------------------------------------------------+
    | CUDA                         | alpaka                                                  |
    +==============================+=========================================================+
    | cudaStreamAddCallback        | alpaka::queue::enqueue(queue, [](){dosomething();})     |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamAttachMemAsync     | --                                                      |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamCreate             | - queue=alpaka::queue::QueueCudaRtNonBlocking(device);  |
    | \                            | - queue=alpaka::queue::QueueCudaRtBlocking(device);     |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamCreateWithFlags    | see cudaStreamCreate (cudaStreamNonBlocking hard coded) |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamCreateWithPriority | --                                                      |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamDestroy            | n/a (Destructor)                                        |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamGetFlags           | --                                                      |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamGetPriority        | --                                                      |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamQuery              | bool alpaka::queue::empty(queue)                        |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamSynchronize        | void alpaka::wait::wait(queue)                          |
    +------------------------------+---------------------------------------------------------+
    | cudaStreamWaitEvent          | void alpaka::wait::wait(queue, event)                   |
    +------------------------------+---------------------------------------------------------+

*Event Management*

.. table::

    +--------------------------+--------------------------------------------+
    | CUDA                     | alpaka                                     |
    +==========================+============================================+
    | cudaEventCreate          | alpaka::event::Event< TQueue > event(dev); |
    +--------------------------+--------------------------------------------+
    | cudaEventCreateWithFlags | --                                         |
    +--------------------------+--------------------------------------------+
    | cudaEventDestroy         | n/a (Destructor)                           |
    +--------------------------+--------------------------------------------+
    | cudaEventElapsedTime     | --                                         |
    +--------------------------+--------------------------------------------+
    | cudaEventQuery           | bool alpaka::event::test(event)            |
    +--------------------------+--------------------------------------------+
    | cudaEventRecord          | void alpaka::queue::enqueue(queue, event)  |
    +--------------------------+--------------------------------------------+
    | cudaEventSynchronize     | void alpaka::wait::wait(event)             |
    +--------------------------+--------------------------------------------+

*Memory Management*

.. table::

    +----------------------------+--------------------------------------------------------------------------------------------+
    | CUDA                       | alpaka                                                                                     |
    +============================+============================================================================================+
    | cudaArrayGetInfo           | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaFree                   | n/a (automatic memory management with reference counted memory handles)                    |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaFreeArray              | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaFreeHost               | n/a                                                                                        |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaFreeMipmappedArray     | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaGetMipmappedArrayLevel | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaGetSymbolAddress       | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaGetSymbolSize          | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaHostAlloc              | n/a, the existing buffer can be pinned using alpaka::mem::buf::prepareForAsyncCopy(memBuf) |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaHostGetDevicePointer   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaHostGetFlags           | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaHostRegister           | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaHostUnregister         | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMalloc                 | alpaka::mem::buf::alloc<TElement>(device, extents1D)                                       |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMalloc3D               | alpaka::mem::buf::alloc<TElement>(device, extents3D)                                       |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMalloc3DArray          | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMallocArray            | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMallocHost             | alpaka::mem::buf::alloc<TElement>(device, extents) 1D, 2D, 3D suppoorted!                  |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMallocManaged          | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMallocMipmappedArray   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMallocPitch            | alpaka::mem::alloc<TElement>(device, extents2D)                                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemAdvise              | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemGetInfo             | - alpaka::dev::getMemBytes                                                                 |
    |                            | - alpaka::dev::getFreeMemBytes                                                             |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemPrefetchAsync       | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemRangeGetAttribute   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemRangeGetAttributes  | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy                 | alpaka::mem::view::copy(memBufDst, memBufSrc, extents1D)                                   |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2D               | alpaka::mem::view::copy(memBufDst, memBufSrc, extents2D)                                   |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DArrayToArray   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DAsync          | alpaka::mem::view::copy(memBufDst, memBufSrc, extents2D, queue)                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DFromArray      | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DFromArrayAsync | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DToArray        | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy2DToArrayAsync   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy3D               | alpaka::mem::view::copy(memBufDst, memBufSrc, extents3D)                                   |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy3DAsync          | alpaka::mem::view::copy(memBufDst, memBufSrc, extents3D, queue)                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy3DPeer           | alpaka::mem::view::copy(memBufDst, memBufSrc, extents3D)                                   |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpy3DPeerAsync      | alpaka::mem::view::copy(memBufDst, memBufSrc, extents3D, queue)                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyArrayToArray     | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyAsync            | alpaka::mem::view::copy(memBufDst, memBufSrc, extents1D, queue)                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyFromArray        | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyFromArrayAsync   | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyFromSymbol       | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyFromSymbolAsync  | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyPeer             | alpaka::mem::view::copy(memBufDst, memBufSrc, extents1D)                                   |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyPeerAsync        | alpaka::mem::view::copy(memBufDst, memBufSrc, extents1D, queue)                            |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyToArray          | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyToArrayAsync     | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyToSymbol         | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyToSymbolAsync    | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemset                 | alpaka::mem::view::set(memBufDst, byte, extents1D)                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemset2D               | alpaka::mem::view::set(memBufDst, byte, extents2D)                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemset2DAsync          | alpaka::mem::view::set(memBufDst, byte, extents2D, queue)                                  |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemset3D               | alpaka::mem::view::set(memBufDst, byte, extents3D)                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemset3DAsync          | alpaka::mem::view::set(memBufDst, byte, extents3D, queue)                                  |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemsetAsync            | alpaka::mem::view::set(memBufDst, byte, extents1D, queue)                                  |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | makecudaExtent             | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | makecudaPitchedPtr         | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | makecudaPos                | --                                                                                         |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyHostToDevice     | n/a (direction of copy is determined automatically)                                        |
    +----------------------------+--------------------------------------------------------------------------------------------+
    | cudaMemcpyDeviceToHost     | n/a (direction of copy is determined automatically)                                        |
    +----------------------------+--------------------------------------------------------------------------------------------+


*Execution Control*

.. table::

    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | CUDA                       | alpaka                                                                                                       |
    +============================+==============================================================================================================+
    | cudaFuncGetAttributes      | --                                                                                                           |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | cudaFuncSetCacheConfig     | --                                                                                                           |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | cudaFuncSetSharedMemConfig | --                                                                                                           |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | cudaLaunchKernel           | - alpaka::kernel::exec<TAcc>(queue, workDiv, kernel, params...)                                              |
    | \                          | - alpaka::kernel::BlockSharedExternMemSizeBytes< TKernel<TAcc> >::getBlockSharedExternMemSizeBytes<...>(...) |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | cudaSetDoubleForDevice     | n/a (alpaka assumes double support)                                                                          |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+
    | cudaSetDoubleForHost       | n/a (alpaka assumes double support)                                                                          |
    +----------------------------+--------------------------------------------------------------------------------------------------------------+

*Occupancy*

.. table::

    +--------------------------------------------------------+--------+
    | CUDA                                                   | alpaka |
    +========================================================+========+
    | cudaOccupancyMaxActiveBlocksPerMultiprocessor          | --     |
    +--------------------------------------------------------+--------+
    | cudaOccupancyMaxActiveBlocksPerMultiprocessorWithFlags | --     |
    +--------------------------------------------------------+--------+


*Unified Addressing*

.. table::

    +--------------------------+--------+
    | CUDA                     | alpaka |
    +==========================+========+
    | cudaPointerGetAttributes | --     |
    +--------------------------+--------+


*Peer Device Memory Access*

.. table::

    +-----------------------------+----------------------------------+
    | CUDA                        | alpaka                           |
    +=============================+==================================+
    | cudaDeviceCanAccessPeer     | --                               |
    +-----------------------------+----------------------------------+
    | cudaDeviceDisablePeerAccess | --                               |
    +-----------------------------+----------------------------------+
    | cudaDeviceEnablePeerAccess  | automatically done when required |
    +-----------------------------+----------------------------------+

**OpenGL, Direct3D, VDPAU, EGL, Graphics Interoperability**

*not available*

**Texture/Surface Reference/Object Management**

*not available*

**Version Management**

*not available*
